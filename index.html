<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .label {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
            transition: all 0.2s ease;
            user-select: none;
            white-space: nowrap;
        }

        .label:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transform: translate(-50%, -50%) scale(1.05);
        }

        .label.hidden {
            display: none;
        }

        .help-text {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            pointer-events: none;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            font-size: 16px;
            max-width: 500px;
            text-align: center;
        }

        #labels-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <div id="labels-container"></div>
        <div class="help-text">
            Drag to rotate • Scroll to zoom • Right-click to pan
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // ============================================
        // CONFIGURATION
        // ============================================

        // GLB file path (relative to this HTML file)
        const MODEL_PATH = 'model.glb';

        // Label definitions - customize positions for your model
        const labels = [
            {
                id: "di",
                text: "D.I. Water Polishing bed",
                position: { x: 0.3, y: 0, z: 0 }
            },
            {
                id: "cell_stack",
                text: "Cell Stack",
                position: { x: 0.5, y: -0.2, z: 0 }
            },
            {
                id: "hydrogen_phase",
                text: "Hydrogen Phase Separator",
                position: { x: 0.5, y: 0.2, z: 0 }
            },
            {
                id: "oxygen_phase",
                text: "Oxygen Phase Separator",
                position: { x: 0.7, y: 0, z: 0 }
            },
            {
                id: "control_panel",
                text: "Control Panel",
                position: { x: 0.5, y: 0.5, z: 0 }
            },
            {
                id: "circulation_pump",
                text: "Circulation Pump",
                position: { x: 0.7, y: -0.3, z: 0 }
            },
            {
                id: "hydrogen_gas_dryer",
                text: "Hydrogen Gas Dryer",
                position: { x: 0.7, y: 0.3, z: 0 }
            },
            {
                id: "generator",
                text: "Generator",
                position: { x: -0.5, y: 0, z: 0 }
            },
        ];

        // Camera initial position - adjust to fit your model
        const CAMERA_INITIAL_POSITION = { x: 5, y: 3, z: 5 };

        // ============================================
        // SCENE SETUP
        // ============================================

        const container = document.getElementById('canvas-container');
        const labelsContainer = document.getElementById('labels-container');

        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        // Camera
        const camera = new THREE.PerspectiveCamera(
            45,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.set(
            CAMERA_INITIAL_POSITION.x,
            CAMERA_INITIAL_POSITION.y,
            CAMERA_INITIAL_POSITION.z
        );

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;
        controls.minDistance = 1;
        controls.maxDistance = 50;

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight1.position.set(5, 10, 5);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-5, 5, -5);
        scene.add(directionalLight2);

        // ============================================
        // LABEL SYSTEM
        // ============================================

        const labelElements = [];

        function createLabels() {
            labels.forEach(label => {
                const div = document.createElement('div');
                div.className = 'label';
                div.textContent = label.text;
                div.addEventListener('click', () => {
                    console.log('Clicked label:', label.id);
                    // You can add more interaction here, e.g., show a tooltip
                    alert(`Clicked: ${label.text}`);
                });
                labelsContainer.appendChild(div);

                labelElements.push({
                    id: label.id,
                    element: div,
                    position: new THREE.Vector3(label.position.x, label.position.y, label.position.z)
                });
            });
        }

        function updateLabels() {
            const vector = new THREE.Vector3();

            labelElements.forEach(label => {
                // Clone the position to avoid modifying the original
                vector.copy(label.position);

                // Project to screen space
                vector.project(camera);

                // Check if behind camera
                if (vector.z > 1) {
                    label.element.classList.add('hidden');
                    return;
                } else {
                    label.element.classList.remove('hidden');
                }

                // Convert to screen coordinates
                const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;

                label.element.style.left = `${x}px`;
                label.element.style.top = `${y}px`;
            });
        }

        // ============================================
        // MODEL LOADING
        // ============================================

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.appendChild(errorDiv);
        }

        const loader = new GLTFLoader();

        loader.load(
            MODEL_PATH,
            // Success callback
            (gltf) => {
                const model = gltf.scene;
                scene.add(model);

                // Center and frame the model
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());

                // Center the model
                model.position.sub(center);

                // Adjust camera to fit the model
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                cameraZ *= 1.5; // Add some padding

                camera.position.set(cameraZ, cameraZ * 0.6, cameraZ);
                camera.lookAt(0, 0, 0);
                controls.target.set(0, 0, 0);
                controls.update();

                console.log('Model loaded successfully');
            },
            // Progress callback
            (xhr) => {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            // Error callback
            (error) => {
                console.error('Error loading model:', error);
                showError(`Failed to load model: ${MODEL_PATH}\n\nMake sure the file exists in the same directory as this HTML file.`);
            }
        );

        // ============================================
        // ANIMATION LOOP
        // ============================================

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updateLabels();
            renderer.render(scene, camera);
        }

        // ============================================
        // WINDOW RESIZE HANDLER
        // ============================================

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // ============================================
        // INITIALIZATION
        // ============================================

        createLabels();
        animate();
    </script>
</body>
</html>
